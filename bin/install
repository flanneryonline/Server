#!/bin/sh

set -o errexit
set -o nounset

export ASSUME_ALWAYS_YES=YES
export PAGER=cat

command -v zfs >/dev/null 2>&1 || { echo >&2 "zfs command is required but it's not installed.  Aborting."; exit 1; }
command -v curl >/dev/null 2>&1 || { echo >&2 "curl command is required but it's not installed.  Aborting."; exit 1; }
command -v sysrc >/dev/null 2>&1 || { echo >&2 "sysrc command is required but it's not installed.  Aborting."; exit 1; }
command -v freebsd-update >/dev/null 2>&1 || { echo >&2 "freebsd-update command is required but it's not installed.  Aborting."; exit 1; }
command -v zpool >/dev/null 2>&1 || { echo >&2 "zpool command is required but it's not installed.  Aborting."; exit 1; }
command -v gpart >/dev/null 2>&1 || { echo >&2 "gpart command is required but it's not installed.  Aborting."; exit 1; }
command -v gnop >/dev/null 2>&1 || { echo >&2 "gnop command is required but it's not installed.  Aborting."; exit 1; }

fast_drive_list="ada0"
root_drive_list="da0 da1"
backup_nfs="server-nas.flanneryonline.com:/volume1/backup"
delete_drive_list="${root_drive_list} ${fast_drive_list}"

release=${RELEASE:-"11.0-RELEASE"}
arch=${ARCH:-$(uname -m)}

altroot=${ALTROOT:-"/mnt"}
temp_dir=${TEMP_DIR:-"/var/tmp/install"}
zcache=${ZCACHE:-"${temp_dir}/zpool.cache"}

base_jail_dir=${BASE_JAIL_DIR:-"/usr/jails"}
jail_dir=${JAIL_DIR:-"${altroot}${base_jail_dir}"}
base_port_dir=${BASE_PORT_DIR:-"/usr/ports"}
port_dir=${PORT_DIR:-"${altroot}${base_port_dir}"}

root_pool=${ROOT_POOL:-"zroot"}
fast_pool=${FAST_POOL:-"zfast"}
storage_pool=${STORAGE_POOL:-"zstorage"}

media_zfs=${MEDIA_ZFS:-"${storage_pool}/media"}
media_dir=${MEDIA_DIR:-"/mnt/media"}
download_zfs=${DOWNLOAD_ZFS:-"${storage_pool}/download"}
download_dir=${DOWNLOAD_DIR:-"/mnt/download"}

config_zfs=${CONFIG_ZFS:-"${storage_pool}/config"}
config_dir=${CONFIG_DIR:-"/mnt/config"}
share_zfs=${SHARE_ZFS:-"${storage_pool}/share"}
share_dir=${SHARE_DIR:-"/mnt/share"}

port_zfs=${PORT_ZFS:-"${fast_pool}/ports"}
jail_zfs=${JAIL_ZFS:-"${fast_pool}/jails"}

gateway=${GATEWAY:-"10.0.0.1"}
subnet=${SUBNET:-"255.0.0.0"}
domain=${DOMAIN:-"flanneryonline.com"}
hostname=${SERVER_HOSTNAME:-"hostserver${t:-}"}
fqdn="${hostname}.${domain}"
host_ip=$(host "${fqdn}" | grep "has address" | awk '{print $4}')

t="test"
if [ ${TESTING:-"YES"} = "NO" ] ; then t=""; fi

if [ -z "${host_ip}" ]
then
    echo >&2 "Hostname ${fqdn} not found in DNS - setup DNS first."
    exit 1
fi

if [ -d "${temp_dir}" ] ; then rm -R "${temp_dir}"; fi
mkdir -p "${temp_dir}"


. ~/server/include/jail/init
. ~/server/include/networking/init
. ~/server/include/software/init
. ~/server/include/system/init
. ~/server/include/system/install
. ~/server/include/user/init
. ~/server/include/zfs/init

echo "Setting up ZFS."
zfs_init

echo "Installing system."
system_install "${altroot}" 1 1

#some stuff requires /dev in chroot
mount -t devfs devfs "${altroot}/dev"

echo "Configuring system."

system_init
software_init
user_init
networking_init
jail_init

echo "Set passwords."
chroot "${altroot}" passwd "root"
chroot "${altroot}" passwd "homeadmin"

while [ -z ${password:-} ]
do
    read -s -p "Enter ssmtp password: " password
    if [ -z ${password} ] 
    then 
        echo ""
        echo "Must not be blank! try again..."
    fi
done

mkdir -p "${altroot}/usr/local/etc/ssmtp"
echo "AuthPass=${password}" >> "${altroot}/usr/local/etc/ssmtp/ssmtp.conf"

echo "Creating install snapshots."
zfs snapshot -r zroot@install
zfs snapshot -r zfast@install
zfs snapshot -r zstorage@install

echo "Cleaning up..."
umount "${altroot}/dev"
cp "${zcache}" "${altroot}/boot/zfs/zpool.cache"
rm -R "${temp_dir}"

echo "Syncing."
sync

echo "Done!"
exit 0

