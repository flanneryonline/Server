#!/usr/bin/env bash

set -o errexit

export ASSUME_ALWAYS_YES=yes
export PAGER=cat

echo "Attempting to update FreeBSD."
if \
    pkg info -x 'pkg(-devel)?$' >/dev/null 2>&1
then
    echo "    running pkg bootstrap"
    pkg bootstrap
fi

#make sure bootstrap worked
if \
    pkg info -x 'pkg(-devel)?$' >/dev/null 2>&1
then
    echo "****pkg init failed. bootstrap didn't work. Check pkg man pages for updates.****"
    exit 1
fi

echo "    pkg update..."
pkg update

echo "    pkg upgrade..."
pkg upgrade

echo "    pkg autoremove..."
pkg autoremove

echo "   Running audit..."
pkg audit -F

echo "    freebsd-update..."
freebsd-update fetch
freebsd-update install

echo "    cleaning up..."
pkg clean -ay
for i in /var/db/freebsd-update/files/*
do 
    rm "$i"
done

echo "Update complete."
exit 0
