#!/usr/bin/env bash

export DEBIAN_FRONTEND=noninteractive
SERVER_INSTALL=${SERVER_INSTALL:-/opt/server}
. "$SERVER_INSTALL/environment"
. "$SERVER_INSTALL/include"

snapshot_date=$(date -Is)
e=0

echo "creating update snapshot(s)"
zfs snapshot -r $ROOT_POOL@$snapshot_date
errorcheck && echoerr "error during zfs snapshot" && exit 1

server_update
errorcheck && echoerr "error during server update - rolling back" && \
    /opt/server/bin/zfs_fullrollback $ROOT_POOL $snapshot_date && \
    e=1

echo "removing snapshot(s)"
/opt/server/bin/zfs_fulldestroy $ROOT_POOL $snapshot_date

exit $e