#!/usr/bin/env bash

. /opt/server/environment
. /opt/server/include

snapshot_date=$(date -Is)

take_snapshot() {
    zfs snapshot $ROOT_POOL/ROOT/$SERVER_DIST/$SERVER_DIST_RELEASE@$snapshot_date
    errorcheck && echoerr "error during zfs snapshot" && return 1

    return 0
}

run_updates() {
    docker_compose_update
    errorcheck && echoerr "error during docker compose update" && return 1

    server_update
    errorcheck && echoerr "error during server update" && return 1

    return 0
}

rollback_snapshot() {
    zfs rollback $ROOT_POOL/ROOT/$SERVER_DIST/$SERVER_DIST_RELEASE@$snapshot_date
}

take_snapshot
errorcheck && exit 1

run_updates
errorcheck && rollback_snapshot && exit 1

exit 0