#!/usr/bin/env bash

export DEBIAN_FRONTEND=noninteractive
SERVER_INSTALL=${SERVER_INSTALL:-/opt/server}
. "$SERVER_INSTALL/environment"
. "$SERVER_INSTALL/include"

snapshot_date=$(date -Is)

zfs snapshot $ROOT_POOL/ROOT/$SERVER_DIST/$SERVER_DIST_RELEASE@$snapshot_date
errorcheck && echoerr "error during zfs snapshot" && exit 1

server_update
errorcheck && echoerr "error during server update - rolling back" && \
    zfs rollback $ROOT_POOL/ROOT/$SERVER_DIST/$SERVER_DIST_RELEASE@$snapshot_date && \
    exit 1
zfs destroy $ROOT_POOL/ROOT/$SERVER_DIST/$SERVER_DIST_RELEASE@$snapshot_date

exit 0